name: Sanity Test with Mlflow Integration
on: 
  workflow_dispatch: 
permissions: 
  contents: write 
  pull-requests: write 
  id-token: write
jobs: 
  test_model:
    runs-on: ubuntu-latest 
    steps: 
      - name: Checkout 
        uses: actions/checkout@v3
        
      - name: GCP Auth
        uses: 'google-github-actions/auth@v3'
        with:
            project_id: 'gentle-presence-472611-u8'
            token_format: 'access_token'
            workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
            service_account: ${{ secrets.SA_EMAIL }}
      - name: Set up Python 
        uses: actions/setup-python@v4
        with: 
          python-version: "3.9"
      - name: CML Setup 
        uses: iterative/setup-cml@v2
      - name: Run Unit Tests 
        run: |
          pip install -r week5/requirements.txt
          python3 week5/test.py > test_output.txt 
      - name: CML Report 
        env: 
          REPO_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Test Output" >> report.md
          echo "------" >> report.md
          cat test_output.txt >> report.md
          echo "------" >> report.md
          cml comment create --publish report.md
